name: Build JNI lib.so

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout source (Standard)
    - name: Checkout source
      uses: actions/checkout@v4

    # 2️⃣ Check & Unzip (Safety added)
    - name: Unzip project
      run: |
        if [ -f "jni.zip" ]; then
          echo "✅ jni.zip found, extracting..."
          unzip -q jni.zip  # -q for quiet mode
          ls -R jni/        # List files to verify structure in logs
        else
          echo "❌ Error: jni.zip not found!"
          exit 1
        fi

    # 3️⃣ Set up JDK (Standard)
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 4️⃣ Setup Android NDK (⚡ HUGE IMPROVEMENT ⚡)
    # This replaces your Cache + Download + Set ENV steps with 1 simple step.
    - name: Setup Android NDK
      uses: nttld/setup-ndk@v1
      with:
        ndk-version: r25c

    # 5️⃣ Build lib.so (Optimized)
    - name: Build lib.so
      run: |
        ndk-build -j$(nproc) \
          NDK_PROJECT_PATH=. \
          APP_BUILD_SCRIPT=jni/Android.mk \
          NDK_APPLICATION_MK=jni/Application.mk \
          NDK_DEBUG=0 \
          V=1

    # 6️⃣ Upload lib.so (Standard)
    - name: Upload lib.so
      uses: actions/upload-artifact@v4
      with:
        name: native-lib
        path: libs/**/*.so
        if-no-files-found: error # Fail if no .so files were built
